---
title: "02102021_PCA_heatmap_afterfiltering"
author: "Gijsje"
date: "2/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r echo=FALSE}
#==========================================================================================================#
#                                              required packages                                           #
#==========================================================================================================#
library(devtools)
library(factoextra)
library(ggfortify)
library(ggplot2)
library(dplyr)
library(broom)
library(variancePartition)
library(pheatmap)
library(edgeR)
library(limma)
library(DESeq2)
library(Hmisc)
library(matrixStats)
```

```{r echo=FALSE}
load("~/Documents/MiGASti/Databases/gene_matrix.RData")
metadata <- read.table("~/Documents/MiGASti/Databases/metadata.txt")
#set rownames to Sample
row.names(metadata) <- metadata$Sample 
#remove low count genes
cpm <- cpm(genes_counts) 
# CPM >= 1 in at least 50% of the samples
keep.exp <- rowSums(cpm > 1) >= (0.5 * ncol(genes_counts) )
genes_counts5 <- genes_counts[ keep.exp, ] #18625 genes 
#performing voom normalisation on data
counts_voom <- limma::voom(genes_counts5)
genes_counts_voom <- counts_voom$E
#order metadata and genes counts
rownames(metadata)
colnames(genes_counts_voom)
genes_counts_ordered <- genes_counts_voom[,rownames(metadata)]
head(genes_counts_ordered)
all(rownames(metadata) == colnames (genes_counts_ordered)) #TRUE
```

# Removal of samples that did not meet criteria QC: 496 samples in total 

```{r echo=FALSE}
setwd("~/Documents/MiGASti/Databases")
exclude <- read.table("samples2remove.txt")
exclude <- exclude$x
genes_counts_filt = genes_counts_ordered[, !colnames(genes_counts_ordered) %in% exclude] 
#Excludes the samples from filters. 
# dim(genes_counts_ordered)
metadata_filt = metadata[ !(rownames(metadata) %in% exclude), ]
length(metadata_filt)
pca = prcomp(t(genes_counts_filt), scale. = TRUE, center = TRUE)
autoplot(pca, data= metadata_filt, colour = 'Stimulation', shape = FALSE, label.size = 2)
```
# summary of the PCA; up to 

```{r echo=FALSE}
summary(pca)
PoV <- pca$sdev^2/sum(pca$sdev^2)
sum(PoV)
```


#Heatmap with 20 PCS (including uncultured)

```{r echo=FALSE}
#set metadata to no capitals
names(metadata_filt) = tolower(names(metadata_filt))
indx <- sapply(metadata, is.character)
metadata[indx] <- lapply(metadata[indx], function(x) as.factor(x))

#include covariates
covariates = c( "donor_id", 
                "region",
                "stimulation",
                "number",
                "average_library_size",
                "qubit_conc",
                "diagnosis",
                "main_diagnosis",
                "sex",
                "age",
                "pmd_minutes",
                "ph",
                "cause_of_death_categories",
                "smoking",
                "alcohol_dependence_daily_use",
                "autoimmune_diseases",
                "infection_2weeks",
                "opiates",
                "benzodiazepines",
                "psychopharmaca",
                "year_collected",
                "trimmomatic_dropped_pct", 
                "picard_pct_mrna_bases",
                "picard_pct_ribosomal_bases",
                "picard_pct_intronic_bases",
                "picard_pct_intergenic_bases",
                "picard_pct_pf_reads_aligned",
                "picard_summed_median",
                "picard_summed_mean",
                "picard_pct_percent_duplication",
                "star_total_reads",
                "star_uniquely_mapped", 
                "star_uniquely_mapped_percent",
                "featurecounts_assigned")

#create format matrix 
matrix_rsquared = matrix(NA, nrow = length(covariates), ncol = 20) #Number of factors
matrix_pvalue = matrix(NA, nrow = length(covariates), ncol = 20)

#lineair model function 
for (x in 1:length(covariates)){
  for (y in 1:20){
    matrix_rsquared[x,y] <- summary( lm(pca$x[,y] ~ metadata_filt[,covariates[x]]) )$adj.r.squared
    matrix_pvalue[x,y] <- tidy( lm(pca$x[,y] ~ metadata_filt[,covariates[x]]) )$p.value[2] #To insert pvalues in the heatmap
  }
}

#fill matrix with values 
matrix_rsquared <- as.data.frame(matrix_rsquared)
matrix_pvalue <- as.data.frame(matrix_pvalue)
rownames(matrix_rsquared) <- covariates
rownames(matrix_pvalue) <- covariates 

#create heatmap with rsquared values 
pheatmap(matrix_rsquared)
#create heatmap with pvalue 
pheatmap(matrix_pvalue)
```


#Boxplot PC3: heatmap V3  

```{r echo=FALSE}
PC3 <- pca$x[,3]
Stimulation <- metadata_filt$stimulation
df = data.frame(Stimulation, PC3)
ggplot(data = df, mapping = aes(x = Stimulation, y = PC3)) +
  geom_boxplot()
```


#removal of uncultured samples (ununstim) 

```{r echo=FALSE}
#remove ununstim samples in metadata
metadata_cultured <- metadata_filt[metadata_filt$stimulation != "ununstim",]
#check numbers
dim(metadata_cultured)
#check numbers per stimulation
table(metadata_filt$stimulation)
#remove samples in genes counts datafile 
genes_counts_cultured <- genes_counts_filt[,metadata_cultured$sample]
pca = prcomp(t(genes_counts_cultured), scale. = TRUE, center = TRUE)
```

#heatmap with 20 PCs without cultured samples: 455 samples  

```{r echo=FALSE}
#set metadata to no capitals
names(metadata_cultured) = tolower(names(metadata_cultured))
indx <- sapply(metadata, is.character)
metadata[indx] <- lapply(metadata[indx], function(x) as.factor(x))

#include covariates
covariates = c( "donor_id", 
                "region",
                "stimulation",
                "number",
                "average_library_size",
                "qubit_conc",
                "diagnosis",
                "main_diagnosis",
                "sex",
                "age",
                "pmd_minutes",
                "ph",
                "cause_of_death_categories",
                "smoking",
                "alcohol_dependence_daily_use",
                "autoimmune_diseases",
                "infection_2weeks",
                "opiates",
                "benzodiazepines",
                "psychopharmaca",
                "year_collected",
                "trimmomatic_dropped_pct", 
                "picard_pct_mrna_bases",
                "picard_pct_ribosomal_bases",
                "picard_pct_intronic_bases",
                "picard_pct_intergenic_bases",
                "picard_pct_pf_reads_aligned",
                "picard_summed_median",
                "picard_summed_mean",
                "picard_pct_percent_duplication",
                "star_total_reads",
                "star_uniquely_mapped", 
                "star_uniquely_mapped_percent",
                "featurecounts_assigned")

#create format matrix 
matrix_rsquared = matrix(NA, nrow = length(covariates), ncol = 20) #Number of factors
matrix_pvalue = matrix(NA, nrow = length(covariates), ncol = 20)

#lineair model function 
for (x in 1:length(covariates)){
  for (y in 1:20){
    matrix_rsquared[x,y] <- summary( lm(pca$x[,y] ~ metadata_cultured[,covariates[x]]) )$adj.r.squared
    matrix_pvalue[x,y] <- tidy( lm(pca$x[,y] ~ metadata_cultured[,covariates[x]]) )$p.value[2] #To insert pvalues in the heatmap
  }
}

#fill matrix with values 
matrix_rsquared <- as.data.frame(matrix_rsquared)
matrix_pvalue <- as.data.frame(matrix_pvalue)
rownames(matrix_rsquared) <- covariates
rownames(matrix_pvalue) <- covariates 

#create heatmap with rsquared values 
pheatmap(matrix_rsquared)
#create heatmap with pvalue 
pheatmap(matrix_pvalue)
```

#Boxplot PC16: heatmap V16  

```{r echo=FALSE}
PC16 <- pca$x[,16]
Stimulation <- metadata_cultured$stimulation
df = data.frame(Stimulation, PC16)
ggplot(data = df, mapping = aes(x = Stimulation, y = PC16)) +
  geom_boxplot()
```
#Boxplot PC12: heatmap V12  

```{r echo=FALSE}
PC12 <- pca$x[,12]
Stimulation <- metadata_cultured$stimulation
df = data.frame(Stimulation, PC12)
ggplot(data = df, mapping = aes(x = Stimulation, y = PC12)) +
  geom_boxplot()
```

# PCA of 1 region: GFM 


```{r echo=FALSE}
metadata_GFM = metadata_cultured[metadata_cultured$region=="GFM",]
#check numbers
dim(metadata_GFM)
#check numbers per stimulation
table(metadata_cultured$region)
#remove samples in genes counts datafile 
genes_counts_GFM <- genes_counts_cultured[,metadata_GFM$sample]
pca = prcomp(t(genes_counts_GFM), scale. = TRUE, center = TRUE)
autoplot(pca, colour = "stimulation", data = metadata_GFM)
```

# PCA of 1 region: SVZ 


```{r echo=FALSE}
metadata_SVZ = metadata_cultured[metadata_cultured$region=="SVZ",]
#check numbers
dim(metadata_SVZ)
#check numbers per stimulation
table(metadata_cultured$region)
#remove samples in genes counts datafile 
genes_counts_SVZ <- genes_counts_cultured[,metadata_SVZ$sample]
pca = prcomp(t(genes_counts_SVZ), scale. = TRUE, center = TRUE)
autoplot(pca, colour = "stimulation", data = metadata_SVZ)
```



# PCA without uncultured samples 1000 most variable genes 

```{r echo=FALSE}
rv <- rowVars(genes_counts_cultured)
  select <- order(rv, decreasing = TRUE)[1:1000]
  pca <- prcomp(t(genes_counts_cultured[select, ]), scale. = TRUE, center = TRUE)
  autoplot(pca, data= metadata_cultured, colour = 'stimulation', shape = FALSE, label.size = 2)
  autoplot(pca, colour = "stimulation", data = metadata_cultured)
```

# PCA without uncultured samples 500 most variable genes 

```{r echo=FALSE}
rv <- rowVars(genes_counts_cultured)
  select <- order(rv, decreasing = TRUE)[1:500]
  pca <- prcomp(t(genes_counts_cultured[select, ]), scale. = TRUE, center = TRUE)
  autoplot(pca, data= metadata_cultured, colour = 'stimulation', shape = FALSE, label.size = 2)
  autoplot(pca, colour = "stimulation", data = metadata_cultured)
```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

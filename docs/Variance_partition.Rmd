---
title: "Variance_partition"
author: "Gijsje"
date: "2/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Required packages

```{r echo = FALSE}
library(variancePartition)
```

```{r echo=FALSE}
load("~/Documents/MiGASti/Databases/gene_matrix.RData")
metadata <- read.table("~/Documents/MiGASti/Databases/metadata.txt")
#set rownames to Sample
row.names(metadata) <- metadata$Sample 
#remove low count genes
cpm <- cpm(genes_counts) 
# CPM >= 1 in at least 50% of the samples
keep.exp <- rowSums(cpm > 1) >= (0.5 * ncol(genes_counts) )
genes_counts5 <- genes_counts[ keep.exp, ] #18625 genes 
#performing voom normalisation on data
counts_voom <- limma::voom(genes_counts5)
genes_counts_voom <- counts_voom$E
#order metadata and genes counts
rownames(metadata)
colnames(genes_counts_voom)
genes_counts_ordered <- genes_counts_voom[,rownames(metadata)]
head(genes_counts_ordered)
all(rownames(metadata) == colnames (genes_counts_ordered)) #TRUE
```

```{r echo=FALSE}
setwd("~/Documents/MiGASti/Databases")
exclude <- read.table("samples2remove.txt")
exclude <- exclude$x
genes_counts_filt = genes_counts_ordered[, !colnames(genes_counts_ordered) %in% exclude] 
#Excludes the samples from filters. 
# dim(genes_counts_ordered)
metadata_filt = metadata[ !(rownames(metadata) %in% exclude), ]
length(metadata_filt)
```

```{r echo = FALSE}
# For categorical covariates you need to include the number 1. Example: (1|Status) + (1|Plate)
#Based on Rsquared heatmap: highest correlation with PCs 

names(metadata_filt) = tolower(names(metadata_filt))

form <- ~ age + (1|donor_id) + picard_pct_intronic_bases + picard_pct_intergenic_bases + picard_pct_ribosomal_bases + picard_summed_mean + (1|region) + featurecounts_assigned + picard_pct_mrna_bases + (1|sex)  + picard_pct_percent_duplication + star_uniquely_mapped + picard_pct_pf_reads_aligned + picard_summed_mean

varPart_tx <- fitExtractVarPartModel(genes_counts_filt, form, metadata_filt)
```

```{r echo = FALSE}
vp <- sortCols( varPart_tx )
plotVarPart(vp)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
